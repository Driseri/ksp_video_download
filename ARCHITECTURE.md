# Архитектура проекта KSP Video Downloader

## Обзор проекта

KSP Video Downloader - это десктопное приложение для загрузки видео с различных платформ, включая специализированную поддержку Kinescope. Приложение построено на Python с использованием PySide6 для GUI и yt-dlp для загрузки видео.

## Структура проекта

```
ksp_video_download/
├── docs/                    # Документация проекта
├── resources/               # Ресурсы приложения
│   ├── locales/            # Файлы локализации
│   │   ├── en.json         # Английские переводы
│   │   └── ru.json         # Русские переводы
│   ├── icon.svg            # Векторная иконка приложения
│   ├── icon.ico            # Иконка для Windows
│   └── convert_icon.py     # Скрипт конвертации иконки
├── src/                    # Исходный код приложения
│   ├── __init__.py
│   ├── main.py             # Точка входа в приложение
│   ├── core/               # Основная бизнес-логика
│   │   ├── __init__.py
│   │   ├── downloader.py   # Загрузчик видео (yt-dlp wrapper)
│   │   ├── logger.py       # Система логирования
│   │   └── localization.py # Система локализации
│   └── ui/                 # Пользовательский интерфейс
│       ├── __init__.py
│       └── main_window.py  # Главное окно приложения
├── tests/                  # Модульные тесты
│   ├── __init__.py
│   └── test_downloader.py  # Тесты загрузчика
├── build.py                # Скрипт сборки приложения
├── run_tests.py           # Скрипт запуска тестов
├── requirements.txt       # Python зависимости
├── test_kinescope.json    # Тестовые данные для Kinescope
├── README.md              # Документация пользователя
└── ARCHITECTURE.md        # Данный файл архитектуры
```

## Основные компоненты

### 1. Точка входа (main.py)

**Назначение**: Инициализация и запуск приложения

**Функции**:
- `setup_environment()`: Настройка окружения (создание директорий, инициализация логгера и локализации)
- `main()`: Основная функция запуска Qt приложения

**Зависимости**: 
- PySide6.QtWidgets.QApplication
- src.ui.main_window.MainWindow
- src.core.logger
- src.core.localization

### 2. Ядро приложения (core/)

#### 2.1 VideoDownloader (downloader.py)

**Назначение**: Загрузка видео с различных платформ

**Основные методы**:
- `download_video()`: Основной метод загрузки
- `download_kinescope_video()`: Специализированная загрузка с Kinescope
- `get_video_info()`: Получение информации о видео
- `_progress_hook()`: Отслеживание прогресса загрузки
- `_format_size()`, `_format_time()`: Утилиты форматирования

**Особенности**:
- Поддержка различных форматов видео
- Настраиваемое качество загрузки
- Callback для отслеживания прогресса
- Специальная обработка Kinescope URL

#### 2.2 Logger (logger.py)

**Назначение**: Централизованная система логирования

**Функции**:
- Ротация логов по размеру
- Различные уровни логирования
- Форматирование сообщений с временными метками
- Запись в файлы и консоль

#### 2.3 Localization (localization.py)

**Назначение**: Поддержка многоязычности

**Функции**:
- Загрузка переводов из JSON файлов
- Автоопределение языка системы
- Функция `_()` для перевода строк
- Поддержка русского и английского языков

### 3. Пользовательский интерфейс (ui/)

#### 3.1 MainWindow (main_window.py)

**Назначение**: Главное окно приложения

**Основные компоненты**:
- Вкладочный интерфейс (General/Kinescope)
- Область drag-and-drop для файлов
- Поля ввода URL и настроек
- Прогресс-бар загрузки
- Кнопки управления

**Методы**:
- `setup_general_tab()`: Настройка общей вкладки
- `setup_kinescope_tab()`: Настройка вкладки Kinescope
- `start_download()`: Запуск загрузки
- `update_progress()`: Обновление прогресса
- `handle_drop_event()`: Обработка перетаскивания файлов

**Особенности дизайна**:
- Унифицированные отступы и интервалы между компонентами
- Фиксированные размеры элементов для предотвращения наложений
- Современный стиль кнопок с градиентами
- Адаптивная компоновка

### 4. Система сборки и тестирования

#### 4.1 Build System (build.py)

**Назначение**: Автоматизация сборки исполняемого файла

**Функции**:
- Конфигурация PyInstaller
- Включение ресурсов и зависимостей
- Создание одного исполняемого файла
- Оптимизация размера

#### 4.2 Testing (tests/)

**Назначение**: Обеспечение качества кода

**Компоненты**:
- Модульные тесты для загрузчика
- Тестовые данные для различных сценариев
- Скрипт автоматического запуска тестов

## Поток данных и взаимодействие компонентов

```
[main.py] 
    ↓ инициализация
[MainWindow] 
    ↓ пользовательский ввод
[VideoDownloader] 
    ↓ загрузка
[yt-dlp] → [Файловая система]
    ↑ прогресс
[MainWindow] ← [Logger]
```

### Детальный поток:

1. **Инициализация**:
   - `main.py` настраивает окружение
   - Инициализируется логгер и локализация
   - Создается главное окно

2. **Пользовательское взаимодействие**:
   - Пользователь вводит URL или перетаскивает файл
   - Выбирает настройки качества и формата
   - Нажимает кнопку загрузки

3. **Процесс загрузки**:
   - MainWindow создает DownloadWorker (QThread)
   - Worker использует VideoDownloader
   - VideoDownloader настраивает yt-dlp
   - Прогресс передается через сигналы Qt

4. **Обратная связь**:
   - Прогресс отображается в UI
   - Логи записываются в файл
   - Уведомления показываются пользователю

## Технологический стек

### Основные зависимости:
- **Python 3.8+**: Основной язык разработки
- **PySide6**: GUI фреймворк (Qt для Python)
- **yt-dlp**: Библиотека для загрузки видео
- **PyInstaller**: Сборка исполняемых файлов

### Дополнительные зависимости:
- **requests**: HTTP запросы
- **Pillow**: Обработка изображений
- **pytest**: Тестирование (dev)

## Конфигурация и настройки

### Локализация:
- Файлы переводов в `resources/locales/`
- Автоматическое определение языка системы
- Поддержка добавления новых языков

### Логирование:
- Логи сохраняются в директории `logs/`
- Ротация по размеру (10MB)
- Различные уровни: DEBUG, INFO, WARNING, ERROR

### Сборка:
- Конфигурация в `build.py`
- Включение всех ресурсов и зависимостей
- Оптимизация для Windows

## Расширяемость и модификации

### Добавление новых платформ:
1. Расширить `VideoDownloader.download_video()`
2. Добавить специфичные методы обработки
3. Обновить UI при необходимости

### Добавление новых языков:
1. Создать JSON файл в `resources/locales/`
2. Добавить язык в `localization.py`
3. Перевести все строки интерфейса

### Модификация UI:
1. Изменить `main_window.py`
2. Сохранить унифицированные стили
3. Обновить тесты при необходимости

## Безопасность и производительность

### Безопасность:
- Валидация пользовательского ввода
- Безопасная обработка файловых путей
- Логирование без чувствительных данных

### Производительность:
- Асинхронная загрузка через QThread
- Эффективное использование памяти
- Оптимизированная сборка приложения

## Известные ограничения

1. Зависимость от yt-dlp для поддержки платформ
2. Требует интернет-соединение для загрузки
3. Ограничения файловой системы для больших файлов
4. Специфичные требования для Kinescope API